<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Answer Reveal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Discourage indexing -->
  <meta name="robots" content="noindex, nofollow" />
  <style>
    :root { color-scheme: light dark; --bg:#0b0b0b; --fg:#f5f5f5; --muted:#888; --brand:#4f7cff;}
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }
    main { max-width: 720px; margin: 0 auto; padding: 24px; }
    header { margin: 8px 0 20px; }
    h1 { font-size: clamp(22px, 5vw, 30px); margin: 0 0 6px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 18px; }
    .muted { color: var(--muted); font-size: 0.95rem; }
    .error { color: #b00020; }
    .answer { font-size: 1.25rem; line-height: 1.4; }
    .hidden { display: none !important; }
    footer { margin-top: 24px; font-size: .9rem; color: var(--muted); }
    .pill { color:#333; background:#f4f7ff; border:1px solid #dae4ff; padding:4px 8px; border-radius:999px; }
    .frameWrap { border: 1px solid #e4e4e4; border-radius: 10px; overflow: hidden; }
    iframe { width: 100%; height: 780px; border: 0; background: white; }
  </style>
</head>
<body>
<main>
  <header>
    <h1>Answer Reveal</h1>
    <p class="muted">Scan the QR code for each puzzle to see that puzzle’s answer.</p>
  </header>

  <!-- Gate (first-time form) -->
  <section id="gate" class="card">
    <h2>Tell us who you are (one-time)</h2>
    <p class="muted">
      Your name and email let us reveal the answer and keep your experience seamless on this device.
    </p>

    <!-- Embedded Google Form -->
    <div class="frameWrap">
      <iframe id="formFrame" title="Answer Access Form" loading="eager"></iframe>
    </div>

    <!-- Guidance + status -->
    <p class="muted" style="margin-top:.5rem;">
      You’ll only need to provide your details once on this device.
    </p>
    <details class="muted" style="margin-top:.25rem;">
      <summary>Privacy notice</summary>
      <p style="margin:.5rem 0 0;">
        We use your name and email to provide the answer and avoid repeated prompts on this device.
        If you opt in, we may email you about new puzzle books or to request feedback. You can unsubscribe anytime using the link in our emails.
        We don’t sell your data.
      </p>
    </details>

    <div id="formMsg" class="muted" aria-live="polite" style="margin-top:6px;"></div>
    <div id="formErr" class="error" aria-live="polite"></div>
  </section>

  <!-- Answer (only after access) -->
  <section id="answer" class="card hidden" aria-live="polite">
    <h2 id="puzzleTitle">Answer</h2>
    <p class="answer">
      <strong>Character:</strong> <span id="character"></span><br />
      <strong>Portrayed by:</strong> <span id="actor"></span>
    </p>
    <p class="muted">
      Seeing this on a shared device? <button class="pill" id="resetBtn" type="button">Not me – clear access</button>
    </p>
  </section>

  <footer>
    <p class="muted">© 2025 Global Publishers</p>
  </footer>
</main>

<script>
/** ============
 *  CONFIG
 *  ============
 */

// Your Google Form (ID you provided)
const GOOGLE_FORM_ID = "1jqjDgS0dCPlpWynArOOmoXVmPNZU9Yv4FxtfRspeuH8";
// Base embed URL
const GOOGLE_FORM_EMBED_BASE = `https://docs.google.com/forms/d/${GOOGLE_FORM_ID}/viewform?embedded=true`;

/*
 * (Optional) If you added a short-answer question in your form named "Puzzle ID"
 * and know its entry ID (looks like entry.1234567890), put it here to prefill it.
 * Leave empty if you don't have that field; everything still works without it.
 */
const ENTRY_PUZZLE_ID = "";  // e.g., "entry.1234567890"

// Answers (per puzzle)
const PUZZLES = {
  "1":  { title: "Puzzle #01", character: "Iron Man (Tony Stark)",                     actor: "Robert Downey Jr." },
  "2":  { title: "Puzzle #02", character: "Captain America (Steve Rogers)",            actor: "Chris Evans" },
  "3":  { title: "Puzzle #03", character: "Thor",                                      actor: "Chris Hemsworth" },
  "4":  { title: "Puzzle #04", character: "Hulk (Bruce Banner)",                       actor: "Mark Ruffalo" },
  "5":  { title: "Puzzle #05", character: "Black Widow (Natasha Romanoff)",            actor: "Scarlett Johansson" },
  "6":  { title: "Puzzle #06", character: "Hawkeye (Clint Barton)",                    actor: "Jeremy Renner" },
  "7":  { title: "Puzzle #07", character: "Spider-Man (Peter Parker)",                 actor: "Tom Holland" },
  "8":  { title: "Puzzle #08", character: "Black Panther (T’Challa)",                  actor: "Chadwick Boseman" },
  "9":  { title: "Puzzle #09", character: "Doctor Strange (Stephen Strange)",          actor: "Benedict Cumberbatch" },
  "10": { title: "Puzzle #10", character: "Captain Marvel (Carol Danvers)",            actor: "Brie Larson" },
  "11": { title: "Puzzle #11", character: "Ant-Man (Scott Lang)",                      actor: "Paul Rudd" },
  "12": { title: "Puzzle #12", character: "The Wasp (Hope van Dyne)",                  actor: "Evangeline Lilly" },
  "13": { title: "Puzzle #13", character: "Scarlet Witch (Wanda Maximoff)",            actor: "Elizabeth Olsen" },
  "14": { title: "Puzzle #14", character: "Vision",                                    actor: "Paul Bettany" },
  "15": { title: "Puzzle #15", character: "Star-Lord (Peter Quill)",                   actor: "Chris Pratt" },
  "16": { title: "Puzzle #16", character: "Gamora",                                    actor: "Zoe Saldana" },
  "17": { title: "Puzzle #17", character: "Drax",                                      actor: "Dave Bautista" },
  "18": { title: "Puzzle #18", character: "Rocket",                                    actor: "Bradley Cooper" },
  "19": { title: "Puzzle #19", character: "Groot",                                     actor: "Vin Diesel" },
  "20": { title: "Puzzle #20", character: "Falcon (Sam Wilson)",                       actor: "Anthony Mackie" },
  "21": { title: "Puzzle #21", character: "Winter Soldier (Bucky Barnes)",             actor: "Sebastian Stan" },
  "22": { title: "Puzzle #22", character: "War Machine (James Rhodes)",                actor: "Don Cheadle" },
  "23": { title: "Puzzle #23", character: "Okoye",                                     actor: "Danai Gurira" },
  "24": { title: "Puzzle #24", character: "Shuri",                                     actor: "Letitia Wright" },
  "25": { title: "Puzzle #25", character: "Mantis",                                    actor: "Pom Klementieff" },
  "26": { title: "Puzzle #26", character: "Valkyrie",                                  actor: "Tessa Thompson" },
  "27": { title: "Puzzle #27", character: "Wong",                                      actor: "Benedict Wong" },
  "28": { title: "Puzzle #28", character: "Nebula",                                    actor: "Karen Gillan" },
  "29": { title: "Puzzle #29", character: "Kate Bishop",                               actor: "Hailee Steinfeld" },
  "30": { title: "Puzzle #30", character: "Yelena Belova",                             actor: "Florence Pugh" },
  "31": { title: "Puzzle #31", character: "Thanos",                                    actor: "Josh Brolin" },
  "32": { title: "Puzzle #32", character: "Loki",                                      actor: "Tom Hiddleston" },
  "33": { title: "Puzzle #33", character: "Hela",                                      actor: "Cate Blanchett" },
  "34": { title: "Puzzle #34", character: "Erik Killmonger (Erik Stevens)",            actor: "Michael B. Jordan" },
  "35": { title: "Puzzle #35", character: "Ultron",                                    actor: "James Spader" },
  "36": { title: "Puzzle #36", character: "Red Skull (Johann Schmidt)",                actor: "Hugo Weaving" },
  "37": { title: "Puzzle #37", character: "Ronan the Accuser",                         actor: "Lee Pace" },
  "38": { title: "Puzzle #38", character: "Taskmaster",                                actor: "Olga Kurylenko" },
  "39": { title: "Puzzle #39", character: "Mysterio (Quentin Beck)",                   actor: "Jake Gyllenhaal" },
  "40": { title: "Puzzle #40", character: "Agatha Harkness",                           actor: "Kathryn Hahn" }
};

// localStorage key used to remember the one-time gate
const ACCESS_KEY = "puzzlebook_player_v1";

/** ============
 *  HELPERS
 *  ============
 */
const $ = (id) => document.getElementById(id);

function getPuzzleId() {
  const url = new URL(window.location.href);
  // prefer '?p=' param; fallback to hash '#'
  return url.searchParams.get("p") || (window.location.hash ? window.location.hash.substring(1) : "");
}

function hasAccess() {
  try {
    return localStorage.getItem(ACCESS_KEY) === "yes";
  } catch {
    return false;
  }
}

function grantAccess() {
  localStorage.setItem(ACCESS_KEY, "yes");
}

function revokeAccess() {
  localStorage.removeItem(ACCESS_KEY);
  location.reload();
}

/** ============
 *  INIT
 *  ============
 */
const puzzleId = getPuzzleId();
const puzzle = PUZZLES[puzzleId];

(function init() {
  // Validate puzzle link early (no spoilers)
  if (!puzzleId || !puzzle) {
    $("gate").classList.add("hidden");
    $("answer").classList.remove("hidden");
    $("puzzleTitle").textContent = "Invalid or missing puzzle link";
    $("character").textContent   = "—";
    $("actor").textContent       = "—";
    return;
  }

  // Build the Google Form embed URL; prefill Puzzle ID if you know ENTRY_PUZZLE_ID
  let src = GOOGLE_FORM_EMBED_BASE;
  if (ENTRY_PUZZLE_ID) {
    const params = new URLSearchParams();
    params.set(ENTRY_PUZZLE_ID, puzzleId);
    src += (src.includes("?") ? "&" : "?") + params.toString();
  }
  const iframe = document.getElementById("formFrame");
  iframe.src = src;

  if (hasAccess()) {
    renderAnswer(puzzle);
  } else {
    wireGate(iframe);
  }

  $("resetBtn").addEventListener("click", revokeAccess);
})();

function renderAnswer(puz) {
  $("gate").classList.add("hidden");
  $("answer").classList.remove("hidden");
  $("puzzleTitle").textContent = puz.title;
  $("character").textContent   = puz.character;
  $("actor").textContent       = puz.actor;
}

function wireGate(iframe) {
  const msg = document.getElementById("formMsg");
  const err = document.getElementById("formErr");

  // Reveal only after SECOND load (initial form -> confirmation page after submit)
  let loads = 0;
  iframe.addEventListener("load", () => {
    loads += 1;
    if (loads === 1) {
      msg.textContent = "Fill the form above and submit to reveal the answer.";
      err.textContent = "";
    } else if (loads >= 2) {
      // Treat as successful submit → grant access and reveal
      grantAccess();
      renderAnswer(puzzle);
      msg.textContent = "";
      err.textContent = "";
    }
  });

  // Optional: show a gentle hint if nothing happens for a long time
  setTimeout(() => {
    if (loads < 2) {
      err.textContent = "If submission seems stuck, please tap Submit again or refresh the page.";
    }
  }, 15000);
}
</script>
</body>
</html>
